<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奇美醫院標準化病人申請作業系統</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 使用 Noto Sans TC 作為預設字體 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        /* 隱藏/顯示 Tab 內容的樣式 */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* 簡易轉場效果 */
        .modal {
            transition: opacity 0.3s ease;
        }
        /* 進度條樣式 */
        .progress-step {
            transition: all 0.3s ease;
        }
        .progress-line {
            transition: all 0.3s ease;
        }
        /* 當前進度閃爍外框動畫 */
        @keyframes blinking-border {
            0% { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.7); } /* blue-500 */
            50% { box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.7); } /* blue-300 */
            100% { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.7); }
        }
        .blinking-shadow {
            animation: blinking-border 1.5s infinite;
        }

        /* 讀取中 spinner 樣式 */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- 主容器 -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl relative">

        <!-- 管理員登入按鈕 -->
        <div class="absolute top-4 right-4 sm:top-6 sm:right-6">
            <button id="admin-login-btn" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 font-medium rounded-lg text-sm px-4 py-2 text-center shadow-sm transition">
                管理員登入
            </button>
        </div>

        <!-- 頁面標頭 -->
        <header class="text-center pt-8 mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 tracking-wide">奇美醫院標準化病人申請作業系統</h1>
        </header>

        <!-- Tab 導覽 -->
        <div class="mb-6 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab" role="tablist">
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg text-blue-600 border-blue-600" id="apply-tab" type="button" role="tab" aria-controls="apply" aria-selected="true">新申請案填寫</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" id="status-tab" type="button" role="tab" aria-controls="status" aria-selected="false">申請進度查詢</button>
                </li>
            </ul>
        </div>

        <!-- Tab 內容 -->
        <div id="myTabContent">
            <!-- 1. 新申請案填寫 -->
            <div class="tab-content active" id="apply" role="tabpanel" aria-labelledby="apply-tab">
                <form id="sp-application-form">
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <!-- Left Column: Basic Info -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm border border-gray-200 h-fit">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </div>
                                <h2 class="text-xl font-bold text-gray-700">一、基本資料</h2>
                            </div>
                            <div class="space-y-6">
                                <div>
                                    <label for="department" class="block mb-2 text-sm font-medium text-gray-900">申請單位</label>
                                    <input type="text" id="department" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="例如：內科部" required>
                                </div>
                                <div>
                                    <label for="applicant" class="block mb-2 text-sm font-medium text-gray-900">申請人</label>
                                    <input type="text" id="applicant" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="王大明" required>
                                </div>
                                <div>
                                    <label for="phone" class="block mb-2 text-sm font-medium text-gray-900">連絡電話</label>
                                    <input type="tel" id="phone" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="0912-345-678 或 分機 12345" required>
                                </div>
                                <div>
                                    <label for="email" class="block mb-2 text-sm font-medium text-gray-900">Email</label>
                                    <input type="email" id="email" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="example@chimei.org.tw" required>
                                </div>
                                <div>
                                    <label for="reason" class="block mb-2 text-sm font-medium text-gray-900">申請標準化病人原因</label>
                                    <textarea id="reason" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="請簡述本次申請原因，例如：PGY OSCE 測驗" required></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- Right Column: SP Info -->
                        <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                             <div class="flex items-center gap-3 mb-6">
                                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                </div>
                                <h2 class="text-xl font-bold text-gray-700">二、標準化病人申請資料</h2>
                            </div>
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <div>
                                        <label for="performance-date" class="block mb-2 text-sm font-medium text-gray-900">預計演出日期</label>
                                        <input type="date" id="performance-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                    </div>
                                    <div class="flex items-end gap-2">
                                        <div class="flex-1">
                                            <label for="start-time" class="block mb-2 text-sm font-medium text-gray-900">演出開始時間</label>
                                            <input type="time" id="start-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                        </div>
                                        <span class="text-gray-500 pb-2.5">至</span>
                                        <div class="flex-1">
                                            <label for="end-time" class="block mb-2 text-sm font-medium text-gray-900">演出結束時間</label>
                                            <input type="time" id="end-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="location" class="block mb-2 text-sm font-medium text-gray-900">演出地點</label>
                                        <input type="text" id="location" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="臨床技能中心" required>
                                    </div>
                                     <div>
                                        <label for="audience" class="block mb-2 text-sm font-medium text-gray-900">測驗對象</label>
                                        <input type="text" id="audience" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="例如：PGY、UGY" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-900">標準化病人需求數</label>
                                    <div id="sp-requirements-container" class="space-y-4">
                                        <!-- 動態新增的欄位會加在這裡 -->
                                    </div>
                                    <button type="button" id="add-sp-requirement" class="mt-4 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        增列一位標病條件
                                    </button>
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-900">檔案上傳 (教案或時程表)</label>
                                    <div class="flex items-center gap-4 mt-2">
                                         <label class="cursor-pointer text-white bg-gray-600 hover:bg-gray-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                                            選擇檔案
                                            <input type="file" id="file-upload" class="hidden">
                                        </label>
                                        <span id="file-name" class="text-sm text-gray-500">尚未選擇檔案</span>
                                    </div>
                                     <p class="mt-1 text-xs text-gray-500">注意：此為介面展示，檔案並不會實際儲存。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 送出按鈕 -->
                    <div class="flex justify-end mt-8">
                        <button type="submit" id="submit-btn" class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-base px-8 py-3 text-center inline-flex items-center gap-2 disabled:bg-gray-400">
                            送出申請
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </form>
            </div>

            <!-- 2. 申請進度查詢 -->
            <div class="tab-content p-4" id="status" role="tabpanel" aria-labelledby="status-tab">
                <div class="bg-white p-6 rounded-lg shadow-md relative min-h-[300px]">
                     <!-- Loading Overlay -->
                    <div id="loading-overlay" class="loading-overlay hidden">
                        <div class="loader"></div>
                    </div>

                     <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-2 sm:mb-0">查詢您的申請紀錄</h2>
                        <div class="flex items-center gap-2">
                             <label for="year-filter" class="text-sm font-medium text-gray-700">年度:</label>
                             <select id="year-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2"></select>
                        </div>
                     </div>
                     <p id="application-count" class="text-lg font-semibold text-gray-600 mb-6"></p>
                     <div class="flex flex-col md:flex-row gap-4 mb-6">
                         <input type="text" id="search-input" class="flex-grow bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="請輸入申請單號或申請人姓名查詢...">
                         <button id="search-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-6 py-2.5">查詢</button>
                     </div>
                     <!-- 查詢結果表格 -->
                     <div class="relative overflow-x-auto">
                         <table class="w-full text-sm text-left text-gray-500">
                             <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                 <tr>
                                     <th scope="col" class="px-6 py-3">申請單號</th>
                                     <th scope="col" class="px-6 py-3">申請人</th>
                                     <th scope="col" class="px-6 py-3">演出日期</th>
                                     <th scope="col" class="px-6 py-3 min-w-[420px]">進度</th>
                                     <th scope="col" class="px-6 py-3">操作</th>
                                 </tr>
                             </thead>
                             <tbody id="status-table-body">
                                 <!-- 查詢結果會動態生成於此 -->
                             </tbody>
                         </table>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 頁尾 -->
    <footer class="text-center py-6 text-sm text-gray-500 mt-8">
        <p>&copy; 奇美醫療財團法人奇美醫院 臨床技能中心</p>
    </footer>

    <!-- 管理員登入 Modal -->
    <div id="login-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full">
            <h3 class="text-2xl font-bold text-center mb-6">管理員登入</h3>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2">帳號</label>
                    <input type="text" id="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Username">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">密碼</label>
                    <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="******************">
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        登入
                    </button>
                    <button type="button" id="cancel-login" class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800">
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 編輯進度 Modal -->
    <div id="edit-status-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full max-h-[90vh] flex flex-col">
            <h3 class="text-2xl font-bold mb-6 flex-shrink-0">編輯申請單</h3>
            <p class="mb-4 flex-shrink-0">申請單號: <span id="editing-app-id" class="font-mono font-bold"></span></p>
            <div class="overflow-y-auto pr-2">
                <!-- 修改演出資訊 -->
                <h4 class="text-lg font-semibold mt-2 mb-3">修改演出資訊</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 border-b pb-6">
                    <div>
                        <label for="edit-performance-date" class="block text-sm font-medium text-gray-700">演出日期</label>
                        <input type="date" id="edit-performance-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                         <div>
                            <label for="edit-start-time" class="block text-sm font-medium text-gray-700">開始時間</label>
                            <input type="time" id="edit-start-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                         </div>
                         <div>
                            <label for="edit-end-time" class="block text-sm font-medium text-gray-700">結束時間</label>
                            <input type="time" id="edit-end-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                         </div>
                    </div>
                </div>

                <!-- 費用核算 -->
                <div class="mt-6 border-b pb-6">
                    <h4 class="text-lg font-semibold mb-3">費用核算</h4>
                    <div class="bg-gray-100 p-4 rounded-lg space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">申請時段:</span>
                            <span id="edit-modal-time-range" class="font-mono font-medium">--:-- - --:--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">核算時數:</span>
                            <span id="edit-modal-billable-hours" class="font-mono font-medium text-blue-600">0 小時</span>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-gray-600 font-medium">單人費用:</span>
                            <span id="edit-modal-cost" class="font-mono font-bold text-xl text-green-600">0 元</span>
                        </div>
                    </div>
                </div>

                <h4 class="text-lg font-semibold mt-6 mb-3">更新進度</h4>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <input id="status-submitted" name="status" type="radio" value="已送單" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                        <label for="status-submitted" class="ml-3 block text-sm font-medium text-gray-700">已送單</label>
                    </div>
                    <div class="flex items-center">
                        <input id="status-received" name="status" type="radio" value="中心收件" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                        <label for="status-received" class="ml-3 block text-sm font-medium text-gray-700">中心收件</label>
                    </div>
                    <div class="flex items-center">
                        <input id="status-arranging" name="status" type="radio" value="安排中" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                        <label for="status-arranging" class="ml-3 block text-sm font-medium text-gray-700">標準化病人安排中</label>
                    </div>
                     <div class="flex items-center">
                        <input id="status-completed" name="status" type="radio" value="已完成" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300">
                        <label for="status-completed" class="ml-3 block text-sm font-medium text-gray-700">已完成</label>
                    </div>
                    <div class="flex items-center">
                        <input id="status-cancelled" name="status" type="radio" value="演出取消" class="focus:ring-red-500 h-4 w-4 text-red-600 border-gray-300">
                        <label for="status-cancelled" class="ml-3 block text-sm font-medium text-red-700">演出取消</label>
                    </div>
                </div>

                <h4 class="text-lg font-semibold mt-6 mb-3 border-t pt-4">指派標病人員</h4>
                <div id="edit-sp-assignment-list" class="space-y-3">
                    <!-- Dynamic content here -->
                </div>
            </div>
             <div class="mt-8 flex justify-end gap-4 flex-shrink-0">
                <button type="button" id="cancel-edit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">取消</button>
                <button type="button" id="save-status" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- 詳情 Modal -->
    <div id="details-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-gray-50 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b bg-white rounded-t-lg">
                <h3 class="text-2xl font-bold text-gray-800">申請單詳情</h3>
                <button id="close-details-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div id="details-content-body" class="p-6 space-y-6 overflow-y-auto">
                 <!-- 內容將由 JS 動態填入 -->
            </div>
        </div>
    </div>

    <!-- JavaScript 邏輯 -->
    <script>
        // --- 模擬後端資料 ---
        // 在實際應用中，這部分會由後端（例如 Google Apps Script）提供
        const MOCK_SP_LIST = ["王小明", "陳美麗", "李大華", "張雅婷", "黃志強", "林秀芬"];
        let MOCK_DB = [
            { id: 'SP20240901', applicant: '王醫師', department: '內科部', date: '2024-10-15', startTime: '09:00', endTime: '12:00', location: '臨床技能中心', phone: '12345', email: 'wang@chimei.org.tw', reason: 'PGY OSCE 測驗', audience: 'PGY', spRequirements: [{ gender: '女', age: '50-60歲', condition: '腹痛教案', assignedSPName: '陳美麗' }, { gender: '男', age: '60-70歲', condition: '胸痛教案', assignedSPName: '李大華' }], status: '已完成', timestamps: { submitted: '2024-09-01 10:30' } },
            { id: 'SP20240905', applicant: '林護理師', department: '護理部', date: '2024-10-20', startTime: '14:00', endTime: '16:00', location: '5A會議室', phone: '54321', email: 'lin@chimei.org.tw', reason: '新進人員溝通訓練', audience: 'N1', spRequirements: [{ gender: '不拘', age: '40-50歲', condition: '困難家屬應對', assignedSPName: '' }], status: '安排中', timestamps: { submitted: '2024-09-05 15:00' } },
            { id: 'SP20240903', applicant: '陳主任', department: '急診部', date: '2024-10-18', startTime: '08:00', endTime: '17:00', location: '臨床技能中心', phone: '11223', email: 'chen@chimei.org.tw', reason: '住院醫師年度評核', audience: 'R1-R3', spRequirements: [{ gender: '男', age: '20-30歲', condition: '創傷情境', assignedSPName: '' }, { gender: '女', age: '70-80歲', condition: '心肌梗塞', assignedSPName: '' }], status: '中心收件', timestamps: { submitted: '2024-09-03 09:00' } },
            { id: 'SP20230810', applicant: '張醫師', department: '外科部', date: '2023-09-01', startTime: '10:00', endTime: '11:00', location: '臨床技能中心', phone: '33445', email: 'chang@chimei.org.tw', reason: '醫學生臨床技能評估', audience: 'UGY', spRequirements: [{ gender: '男', age: '40-50歲', condition: '術前訪視', assignedSPName: '王小明' }], status: '演出取消', timestamps: { submitted: '2023-08-10 11:45', cancelled: '2023-08-20 14:00' } },
        ];

        // --- 模擬 google.script.run ---
        // 這個物件模擬了與 Google Apps Script 後端的通訊，讓我們可以在沒有實際後端的情況下測試前端功能
        const google = {
            script: {
                run: {
                    withSuccessHandler: function(callback) {
                        this.onSuccess = callback;
                        return this;
                    },
                    withFailureHandler: function(callback) {
                        this.onFailure = callback;
                        return this;
                    },
                    getApplications: function() {
                        try {
                            // 模擬網路延遲
                            setTimeout(() => this.onSuccess(JSON.parse(JSON.stringify(MOCK_DB))), 500);
                        } catch(e) {
                            this.onFailure(e.toString());
                        }
                    },
                    submitApplication: function(formData) {
                         try {
                            const today = new Date();
                            const id = `SP${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random()*100)}`;
                            const newApp = { ...formData, id, status: '已送單', timestamps: { submitted: `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')} ${today.getHours()}:${today.getMinutes()}` } };
                            MOCK_DB.unshift(newApp);
                            setTimeout(() => this.onSuccess({ success: true, message: `申請成功！您的申請單號為 ${id}` }), 300);
                         } catch(e) {
                            this.onFailure(e.toString());
                         }
                    },
                    updateApplication: function(updateData) {
                        try {
                             const appIndex = MOCK_DB.findIndex(app => app.id === updateData.id);
                             if (appIndex > -1) {
                                MOCK_DB[appIndex].status = updateData.status;
                                MOCK_DB[appIndex].date = updateData.date;
                                MOCK_DB[appIndex].startTime = updateData.startTime;
                                MOCK_DB[appIndex].endTime = updateData.endTime;
                                updateData.spAssignments.forEach(assignment => {
                                    const reqIndex = parseInt(assignment.index, 10) - 1;
                                    if (MOCK_DB[appIndex].spRequirements[reqIndex]) {
                                        MOCK_DB[appIndex].spRequirements[reqIndex].assignedSPName = assignment.name;
                                    }
                                });
                                setTimeout(() => this.onSuccess({ success: true, message: '更新成功！' }), 300);
                             } else {
                                throw new Error('找不到申請單');
                             }
                        } catch(e) {
                            this.onFailure(e.toString());
                        }
                    },
                    verifyAdmin: function(credentials) {
                        // 簡單的密碼驗證
                        if (credentials.username === 'admin' && credentials.password === 'password') {
                             setTimeout(() => this.onSuccess({ success: true }), 200);
                        } else {
                             setTimeout(() => this.onSuccess({ success: false, message: '帳號或密碼錯誤' }), 200);
                        }
                    }
                }
            }
        };


        function initializeAppLogic() {
            // --- 狀態管理 ---
            let isAdminLoggedIn = false;
            let editingAppId = null;
            let allApplications = []; // 用來緩存從後端抓取的資料

            const statusMap = {
                '已送單': { index: 0, text: '已送單', color: 'bg-gray-400', icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>` },
                '中心收件': { index: 1, text: '中心收件', color: 'bg-sky-500', icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0l-8 5-8-5"></path></svg>` },
                '安排中': { index: 2, text: '安排中', color: 'bg-amber-500', icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` },
                '已完成': { index: 3, text: '已完成', color: 'bg-green-500', icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` },
                '演出取消': { index: 4, text: '演出取消', color: 'bg-red-500', icon: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>` }
            };

            // --- DOM 元素 ---
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const loginModal = document.getElementById('login-modal');
            const cancelLoginBtn = document.getElementById('cancel-login');
            const loginForm = document.getElementById('login-form');
            const editStatusModal = document.getElementById('edit-status-modal');
            const cancelEditBtn = document.getElementById('cancel-edit');
            const saveStatusBtn = document.getElementById('save-status');
            const statusTableBody = document.getElementById('status-table-body');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const detailsModal = document.getElementById('details-modal');
            const closeDetailsModalBtn = document.getElementById('close-details-modal');
            const applicationCountEl = document.getElementById('application-count');
            const yearFilter = document.getElementById('year-filter');
            const editPerformanceDate = document.getElementById('edit-performance-date');
            const editStartTime = document.getElementById('edit-start-time');
            const editEndTime = document.getElementById('edit-end-time');
            const loadingOverlay = document.getElementById('loading-overlay');
            const submitBtn = document.getElementById('submit-btn');
            const fileUploadInput = document.getElementById('file-upload');
            const fileNameSpan = document.getElementById('file-name');

            // --- 函數 ---
            function showLoader(show) {
                loadingOverlay.classList.toggle('hidden', !show);
            }

            function fetchApplications() {
                showLoader(true);
                google.script.run
                    .withSuccessHandler(data => {
                        allApplications = data;
                        populateYearFilter();
                        updateDisplay();
                        showLoader(false);
                    })
                    .withFailureHandler(err => {
                        alert("讀取資料失敗: " + err);
                        showLoader(false);
                    })
                    .getApplications();
            }

            function populateYearFilter() {
                const years = [...new Set(allApplications.map(item => new Date(item.date).getFullYear()))].sort((a, b) => b - a);
                const currentYear = new Date().getFullYear();
                if (!years.includes(currentYear)) {
                    years.unshift(currentYear);
                }
                
                yearFilter.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `${year}年`;
                    yearFilter.appendChild(option);
                });
            }
            
            function updateDisplay() {
                const selectedYear = yearFilter.value;
                const query = searchInput.value.toLowerCase().trim();

                let yearlyData = allApplications.filter(item => new Date(item.date).getFullYear() == selectedYear);
                
                applicationCountEl.innerHTML = `${selectedYear}年度 總案件數：<span class="text-blue-600 font-bold text-xl">${yearlyData.length}</span> 件`;

                let displayData = yearlyData;
                if (query) {
                    displayData = yearlyData.filter(item => 
                        item.id.toLowerCase().includes(query) || 
                        item.applicant.toLowerCase().includes(query) ||
                        item.department.toLowerCase().includes(query)
                    );
                }
                
                renderStatusTable(displayData);
            }

            function renderStatusTable(data) {
                statusTableBody.innerHTML = '';
                if (data.length === 0) {
                    statusTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500">查無資料</td></tr>`;
                    return;
                }
                data.sort((a, b) => new Date(b.timestamps.submitted) - new Date(a.timestamps.submitted));
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.id}</th>
                        <td class="px-6 py-4">${item.department} - ${item.applicant}</td>
                        <td class="px-6 py-4">${item.date}</td>
                        <td class="px-6 py-4">${createProgressBar(item.status, item.timestamps)}</td>
                        <td class="px-6 py-4">
                            <button data-id="${item.id}" class="details-btn font-medium text-blue-600 hover:underline">詳情</button>
                            ${isAdminLoggedIn ? `<button data-id="${item.id}" class="edit-status-btn ml-4 font-medium text-green-600 hover:underline">編輯</button>` : ''}
                        </td>
                    `;
                    statusTableBody.appendChild(row);
                });
            }

            function createProgressBar(currentStatusKey, timestamps) {
                if (currentStatusKey === '演出取消') {
                    const timestamp = timestamps.cancelled || '';
                    return `
                        <div class="flex items-center w-full bg-red-100 p-2 rounded-md">
                            <div class="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center text-white mr-3 flex-shrink-0">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                            </div>
                            <div>
                                <p class="font-bold text-red-700">演出取消</p>
                                <p class="text-xs text-red-600">${timestamp}</p>
                            </div>
                        </div>
                    `;
                }
                
                const currentStepInfo = statusMap[currentStatusKey] || statusMap['已送單'];
                const currentStepIndex = currentStepInfo.index;
                let stepsHtml = '';
                const steps = Object.values(statusMap).filter(s => s.index !== 4).sort((a,b) => a.index - b.index);

                steps.forEach((stepInfo, i) => {
                    const isCompleted = i < currentStepIndex;
                    const isCurrent = i === currentStepIndex;
                    
                    let circleContainerClass = '';
                    let circleColor = 'bg-gray-300';
                    if (isCurrent) {
                        circleContainerClass = 'blinking-shadow rounded-full';
                        circleColor = stepInfo.color;
                    } else if (isCompleted) {
                        circleColor = stepInfo.color;
                    }

                    const timestamp = (i === 0 && timestamps.submitted) ? timestamps.submitted.replace(' ', '<br>') : '';

                    stepsHtml += `
                        <div class="flex-1 flex flex-col items-center text-center">
                            <div class="${circleContainerClass}">
                                <div class="w-8 h-8 rounded-full ${circleColor} flex items-center justify-center text-white">
                                    ${stepInfo.icon}
                                </div>
                            </div>
                            <p class="text-xs mt-2 ${isCurrent ? 'font-bold text-gray-800' : 'text-gray-500'}">${stepInfo.text}</p>
                            <p class="text-[10px] text-gray-400 mt-1 leading-tight">${timestamp}</p>
                        </div>
                    `;

                    if (i < steps.length - 1) {
                        const lineClass = i < currentStepIndex ? statusMap[steps[i+1].text].color : 'bg-gray-300';
                        stepsHtml += `<div class="flex-1 h-1 ${lineClass} progress-line" style="margin-bottom: 3.5rem;"></div>`;
                    }
                });
                return `<div class="flex items-start w-full">${stepsHtml}</div>`;
            }

            function toggleModal(modal, show) {
                if (show) {
                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.add('opacity-100'), 10);
                } else {
                    modal.classList.remove('opacity-100');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }
            
            function calculateCost(startTime, endTime) {
                if (!startTime || !endTime) {
                    return { billableHours: 0, cost: 0 };
                }

                const start = new Date(`1970-01-01T${startTime}:00`);
                const end = new Date(`1970-01-01T${endTime}:00`);

                if (isNaN(start) || isNaN(end) || start >= end) {
                    return { billableHours: 0, cost: 0 };
                }

                let diffMinutes = (end.getTime() - start.getTime()) / 60000;
                
                const hours = Math.floor(diffMinutes / 60);
                const minutes = Math.round(diffMinutes % 60);

                let billableHours = hours;
                 if (minutes > 45) {
                    billableHours += 1;
                } else if (minutes > 15) {
                    billableHours += 0.5;
                }
                
                const cost = billableHours * 500;
                return { billableHours, cost };
            }

            function updateCostDisplayInModal() {
                const startTime = editStartTime.value;
                const endTime = editEndTime.value;

                document.getElementById('edit-modal-time-range').textContent = `${startTime || '--:--'} - ${endTime || '--:--'}`;

                const { billableHours, cost } = calculateCost(startTime, endTime);
                
                document.getElementById('edit-modal-billable-hours').textContent = `${billableHours} 小時`;
                document.getElementById('edit-modal-cost').textContent = `${cost} 元`;
            }

            function showDetails(appId) {
                const app = allApplications.find(item => item.id === appId);
                if (!app) return;

                const detailsBody = document.getElementById('details-content-body');
                
                const spTableRows = app.spRequirements.map((req, index) => `
                    <tr class="border-b">
                        <td class="py-3 px-4 text-center">${index + 1}</td>
                        <td class="py-3 px-4">${req.condition}</td>
                        <td class="py-3 px-4 text-center">${req.gender}</td>
                        <td class="py-3 px-4 text-center">${req.age}</td>
                        <td class="py-3 px-4 font-medium">${req.assignedSPName || '<span class="text-gray-400">未安排</span>'}</td>
                    </tr>
                `).join('');

                detailsBody.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">基本資訊</h4>
                        <dl class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-6">
                            <div class="flex items-start"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div><div class="ml-4"><dt class="text-sm font-medium text-gray-500">申請人</dt><dd class="mt-1 text-base font-semibold text-gray-900">${app.department} - ${app.applicant}</dd></div></div>
                            <div class="flex items-start"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg></div><div class="ml-4"><dt class="text-sm font-medium text-gray-500">連絡電話</dt><dd class="mt-1 text-base font-semibold text-gray-900">${app.phone}</dd></div></div>
                            <div class="flex items-start"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div><div class="ml-4"><dt class="text-sm font-medium text-gray-500">Email</dt><dd class="mt-1 text-base font-semibold text-gray-900">${app.email}</dd></div></div>
                        </dl>
                        <div class="mt-6 pt-4 border-t"><dt class="text-sm font-medium text-gray-500">申請原因</dt><dd class="mt-1 text-base text-gray-800">${app.reason}</dd></div>
                    </div>
                     <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">演出資訊</h4>
                        <dl class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-6">
                            <div class="flex items-start"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div><div class="ml-4"><dt class="text-sm font-medium text-gray-500">演出日期</dt><dd class="mt-1 text-base font-semibold text-gray-900">${app.date}</dd></div></div>
                            <div class="flex items-start"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><div class="ml-4"><dt class="text-sm font-medium text-gray-500">演出時間</dt><dd class="mt-1 text-base font-semibold text-gray-900">${app.startTime} - ${app.endTime}</dd></div></div>
                            <div class="flex items-start"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div><div class="ml-4"><dt class="text-sm font-medium text-gray-500">演出地點</dt><dd class="mt-1 text-base font-semibold text-gray-900">${app.location}</dd></div></div>
                        </dl>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <h4 class="text-xl font-bold text-gray-800 p-6">標病需求與安排</h4>
                        <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center w-12">#</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">需求條件</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">性別</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">年齡</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">已安排人員</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${spTableRows}</tbody></table></div>
                    </div>
                `;
                toggleModal(detailsModal, true);
            }

            function populateEditModal(appId) {
                const app = allApplications.find(item => item.id === appId);
                if (!app) return;
                
                editingAppId = appId;
                document.getElementById('editing-app-id').textContent = app.id;
                editPerformanceDate.value = app.date;
                editStartTime.value = app.startTime;
                editEndTime.value = app.endTime;
                
                document.querySelector(`input[name="status"][value="${app.status}"]`).checked = true;
                
                updateCostDisplayInModal();

                const assignmentContainer = document.getElementById('edit-sp-assignment-list');
                assignmentContainer.innerHTML = '';
                app.spRequirements.forEach((req, index) => {
                    const div = document.createElement('div');
                    div.className = "grid grid-cols-3 gap-2 items-center";
                    div.innerHTML = `
                        <div class="col-span-2 text-sm">
                            <p class="font-medium">${req.condition}</p>
                            <p class="text-xs text-gray-500">需求: ${req.gender}, ${req.age}</p>
                        </div>
                        <input type="text" data-index="${index + 1}" value="${req.assignedSPName || ''}" placeholder="請填寫姓名" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2">
                    `;
                    assignmentContainer.appendChild(div);
                });
                toggleModal(editStatusModal, true);
            }

            // --- 事件監聽 ---
            adminLoginBtn.addEventListener('click', () => {
                if (isAdminLoggedIn) {
                    isAdminLoggedIn = false;
                    adminLoginBtn.textContent = '管理員登入';
                    adminLoginBtn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
                    updateDisplay();
                } else {
                    toggleModal(loginModal, true);
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            isAdminLoggedIn = true;
                            adminLoginBtn.textContent = '管理員登出';
                            adminLoginBtn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                            toggleModal(loginModal, false);
                            loginForm.reset();
                            updateDisplay();
                        } else {
                            alert(response.message);
                        }
                    })
                    .withFailureHandler(err => {
                        alert("登入失敗: " + err);
                    })
                    .verifyAdmin({username: username, password: password});
            });
            cancelLoginBtn.addEventListener('click', () => toggleModal(loginModal, false));

            statusTableBody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.classList.contains('edit-status-btn')) populateEditModal(target.dataset.id);
                if (target.classList.contains('details-btn')) showDetails(target.dataset.id);
            });
            
            saveStatusBtn.addEventListener('click', () => {
                const updateData = {
                    id: editingAppId,
                    status: document.querySelector('input[name="status"]:checked').value,
                    date: editPerformanceDate.value,
                    startTime: editStartTime.value,
                    endTime: editEndTime.value,
                    spAssignments: []
                };

                const assignmentInputs = document.querySelectorAll('#edit-sp-assignment-list input');
                assignmentInputs.forEach(input => {
                    updateData.spAssignments.push({
                        index: input.dataset.index,
                        name: input.value.trim()
                    });
                });

                toggleModal(editStatusModal, false);
                showLoader(true);
                
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            alert(response.message);
                            fetchApplications(); // 重新抓取最新資料
                        } else {
                            alert(response.message);
                            showLoader(false);
                        }
                    })
                    .withFailureHandler(err => {
                        alert("更新失敗: " + err);
                        showLoader(false);
                    })
                    .updateApplication(updateData);
            });

            cancelEditBtn.addEventListener('click', () => toggleModal(editStatusModal, false));
            closeDetailsModalBtn.addEventListener('click', () => toggleModal(detailsModal, false));
            yearFilter.addEventListener('change', updateDisplay);
            searchBtn.addEventListener('click', updateDisplay);
            searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') updateDisplay(); });
            editStartTime.addEventListener('change', updateCostDisplayInModal);
            editEndTime.addEventListener('change', updateCostDisplayInModal);
            editPerformanceDate.addEventListener('change', updateCostDisplayInModal);
            
            fileUploadInput.addEventListener('change', () => {
                if (fileUploadInput.files.length > 0) {
                    fileNameSpan.textContent = fileUploadInput.files[0].name;
                } else {
                    fileNameSpan.textContent = '尚未選擇檔案';
                }
            });

            // --- 初始載入 ---
            document.addEventListener('DOMContentLoaded', () => {
              if (window.google && window.google.script && window.google.script.run) {
                  initializeAppLogic();
              } else {
                  console.log("Mock environment detected, running initializeAppLogic directly.");
                  initializeAppLogic();
              }
            });
            
            // --- 表單邏輯 ---
            const tabs = document.querySelectorAll('#myTab button');
            const tabContents = document.querySelectorAll('#myTabContent .tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    tabs.forEach(t => {
                        t.classList.remove('text-blue-600', 'border-blue-600');
                        t.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                        t.setAttribute('aria-selected', 'false');
                        if(t !== this) {
                            t.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                        }
                    });
                    tabContents.forEach(content => content.classList.remove('active'));
                    this.classList.add('text-blue-600', 'border-blue-600');
                    this.setAttribute('aria-selected', 'true');
                    document.getElementById(this.getAttribute('aria-controls')).classList.add('active');
                    if (this.id === 'status-tab') {
                        fetchApplications();
                    }
                });
            });

            const container = document.getElementById('sp-requirements-container');
            const addButton = document.getElementById('add-sp-requirement');
            let spCount = 0;

            function addSpRequirement() {
                spCount++;
                const requirementDiv = document.createElement('div');
                requirementDiv.className = 'p-4 border border-gray-200 rounded-lg grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 gap-4 items-end relative';
                requirementDiv.innerHTML = `<div class="font-semibold text-gray-600 sm:col-span-3 md:col-span-4">標病 ${spCount}</div><div><label class="block mb-1 text-xs font-medium text-gray-700">性別</label><select class="sp-gender bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"><option selected value="">請選擇</option><option value="男">男</option><option value="女">女</option><option value="不拘">不拘</option></select></div><div><label class="block mb-1 text-xs font-medium text-gray-700">年齡</label><input type="text" class="sp-age bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2" placeholder="例如：40-50歲"></div><div class="sm:col-span-2 md:col-span-1"><label class="block mb-1 text-xs font-medium text-gray-700">演出教案/條件</label><input type="text" class="sp-condition bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2" placeholder="例如：腹痛教案、需能哭"></div><div class="sm:col-start-3 md:col-start-4"><button type="button" class="remove-sp-requirement w-full text-red-600 hover:text-white border border-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-2 text-center">移除</button></div>`;
                container.appendChild(requirementDiv);
                updateSpHeaders();
            }
            
            function updateSpHeaders() {
                 const allSpHeaders = container.querySelectorAll('.font-semibold');
                 allSpHeaders.forEach((header, index) => { header.textContent = `標病 ${index + 1}`; });
                 spCount = allSpHeaders.length;
            }

            addSpRequirement();
            addButton.addEventListener('click', addSpRequirement);

            container.addEventListener('click', function(e) {
                if (e.target.closest('.remove-sp-requirement')) {
                    if (container.querySelectorAll('.p-4').length > 1) {
                         e.target.closest('.p-4').remove();
                         updateSpHeaders();
                    } else {
                        alert("至少需保留一項標病需求。");
                    }
                }
            });

            const form = document.getElementById('sp-application-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = '送出中...';

                const formData = {
                    department: document.getElementById('department').value,
                    applicant: document.getElementById('applicant').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    reason: document.getElementById('reason').value,
                    date: document.getElementById('performance-date').value,
                    startTime: document.getElementById('start-time').value,
                    endTime: document.getElementById('end-time').value,
                    location: document.getElementById('location').value,
                    audience: document.getElementById('audience').value,
                    spRequirements: []
                };

                const requirementNodes = container.querySelectorAll('.p-4');
                let hasEmptyFields = false;
                requirementNodes.forEach(node => {
                    const gender = node.querySelector('.sp-gender').value;
                    const age = node.querySelector('.sp-age').value;
                    const condition = node.querySelector('.sp-condition').value;
                    if (!gender || !age.trim() || !condition.trim()) {
                        hasEmptyFields = true;
                    }
                    formData.spRequirements.push({ gender, age, condition });
                });

                if (hasEmptyFields) {
                    alert('標病需求的欄位(性別、年齡、條件)皆為必填。');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '送出申請 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>';
                    return;
                }
                
                google.script.run
                    .withSuccessHandler(response => {
                        alert(response.message);
                        if (response.success) {
                            form.reset();
                            container.innerHTML = '';
                            spCount = 0;
                            addSpRequirement();
                            fileNameSpan.textContent = '尚未選擇檔案';
                        }
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '送出申請 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>';
                    })
                    .withFailureHandler(err => {
                        alert("送出失敗: " + err);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '送出申請 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>';
                    })
                    .submitApplication(formData);
            });
        }
        
        // DOMContentLoaded is a reliable way to start the script after the page is loaded.
        document.addEventListener('DOMContentLoaded', initializeAppLogic);

    </script>
</body>
</html>
