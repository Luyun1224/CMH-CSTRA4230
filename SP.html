<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>奇美醫院標準化病人申請作業系統</title>
  <!-- Tailwind CDN（保留你原有樣式習慣） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 讀取中 spinner 與淡入動畫（維持原本風格） */
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .loading-overlay { position: absolute; inset: 0; background-color: rgba(255,255,255,0.7); display:flex; align-items:center; justify-content:center; z-index:10; }
    .modal { transition: opacity .2s ease; }
    .hidden { display: none; }
    .fade-in { animation: fadeIn .18s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>

<body class="bg-gray-50">
  <!-- 主容器 -->
  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl relative">
    <!-- 管理員登入 -->
    <div class="absolute top-4 right-4 sm:top-6 sm:right-6">
      <button id="admin-login-btn" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 font-medium rounded-lg text-sm px-4 py-2 text-center shadow-sm transition">
        管理員登入
      </button>
    </div>

    <!-- 標題 -->
    <header class="text-center pt-8 mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 tracking-wide">奇美醫院標準化病人申請作業系統</h1>
    </header>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab" role="tablist">
        <li class="mr-2" role="presentation">
          <button class="inline-block p-4 border-b-2 rounded-t-lg text-blue-600 border-blue-600"
                  id="apply-tab" type="button" role="tab" aria-controls="apply" aria-selected="true">新申請案填寫</button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300"
                  id="status-tab" type="button" role="tab" aria-controls="status" aria-selected="false">申請進度查詢</button>
        </li>
      </ul>
    </div>

    <!-- 內容 -->
    <div id="myTabContent">
      <!-- 1) 新申請案 -->
      <section id="apply" class="block">
        <div class="bg-white rounded-xl shadow p-6 space-y-8">

          <!-- 基本資料 -->
          <div>
            <div class="flex items-center gap-3 mb-3">
              <div class="w-6 h-6 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 font-bold">1</div>
              <h2 class="text-xl font-bold text-gray-700">一、申請人基本資料</h2>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div>
                <label for="department" class="block mb-2 text-sm font-medium text-gray-900">申請單位</label>
                <input type="text" id="department" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="例如：臨床技能中心" required>
              </div>
              <div>
                <label for="applicant" class="block mb-2 text-sm font-medium text-gray-900">申請人</label>
                <input type="text" id="applicant" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="王小明" required>
              </div>
              <div>
                <label for="phone" class="block mb-2 text-sm font-medium text-gray-900">聯絡電話</label>
                <input type="tel" id="phone" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="09xx-xxx-xxx" required>
              </div>
              <div>
                <label for="email" class="block mb-2 text-sm font-medium text-gray-900">Email</label>
                <input type="email" id="email" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="name@chimei.org.tw" required>
              </div>
            </div>

            <div class="mt-6">
              <label for="reason" class="block mb-2 text-sm font-medium text-gray-900">申請理由 / 課程說明</label>
              <textarea id="reason" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" placeholder="請簡述申請原因與課程內容"></textarea>
            </div>
          </div>

          <!-- 申請資訊 -->
          <div>
            <div class="flex items-center gap-3 mb-3">
              <div class="w-6 h-6 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 font-bold">2</div>
              <h2 class="text-xl font-bold text-gray-700">二、標準化病人申請資料</h2>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div>
                <label for="performance-date" class="block mb-2 text-sm font-medium text-gray-900">預計演出日期</label>
                <input type="date" id="performance-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
              </div>
              <div class="flex items-end gap-2">
                <div class="flex-1">
                  <label for="start-time" class="block mb-2 text-sm font-medium text-gray-900">演出開始時間</label>
                  <input type="time" id="start-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <span class="text-gray-500 pb-2.5">至</span>
                <div class="flex-1">
                  <label for="end-time" class="block mb-2 text-sm font-medium text-gray-900">演出結束時間</label>
                  <input type="time" id="end-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
              </div>
              <div>
                <label for="location" class="block mb-2 text-sm font-medium text-gray-900">演出地點</label>
                <input type="text" id="location" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="臨床技能中心" required>
              </div>
              <div>
                <label for="audience" class="block mb-2 text-sm font-medium text-gray-900">測驗對象</label>
                <input type="text" id="audience" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="例如：PGY、UGY" required>
              </div>
            </div>

            <div class="mt-6">
              <label for="teaching-activity" class="block mb-2 text-sm font-medium text-gray-900">教學活動（可選填）</label>
              <input type="text" id="teaching-activity" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="例如：OSCE 站考、Mini-CEX、臨床溝通演練">
            </div>

            <!-- 動態需求 -->
            <div class="mt-6">
              <label class="block mb-2 text-sm font-medium text-gray-900">標準化病人需求數</label>
              <div id="sp-requirements-container" class="space-y-4"></div>
              <button type="button" id="add-sp-requirement" class="mt-4 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5">新增需求</button>
            </div>
          </div>

          <!-- 送出 -->
          <div class="pt-4 border-t flex items-center justify-end">
            <button id="submit-application" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-6 rounded-lg shadow">送出申請</button>
          </div>

        </div>
      </section>

      <!-- 2) 申請進度查詢 -->
      <section id="status" class="hidden">
        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">申請列表</h3>
            <button id="refresh-list" class="text-sm px-3 py-2 rounded border border-gray-300 hover:bg-gray-50">重新整理</button>
          </div>
          <div id="applications-list" class="divide-y divide-gray-100"></div>
          <div id="applications-empty" class="text-gray-500 text-sm py-10 text-center hidden">目前尚無資料</div>
        </div>
      </section>
    </div>
  </div>

  <!-- 管理端：編輯狀態 Modal -->
  <div id="edit-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
    <div class="bg-gray-50 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center p-6 border-b bg-white rounded-t-lg">
        <h3 class="text-2xl font-bold text-gray-800">編輯申請單</h3>
        <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
      </div>
      <div class="p-6 space-y-6 overflow-y-auto">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">日期</label>
            <input type="date" id="edit-date" class="bg-white border border-gray-300 text-sm rounded-lg p-2.5 w-full">
          </div>
          <div class="flex items-end gap-2">
            <div class="flex-1">
              <label class="block mb-2 text-sm font-medium text-gray-900">開始時間</label>
              <input type="time" id="edit-start-time" class="bg-white border border-gray-300 text-sm rounded-lg p-2.5 w-full">
            </div>
            <span class="text-gray-500 pb-2.5">至</span>
            <div class="flex-1">
              <label class="block mb-2 text-sm font-medium text-gray-900">結束時間</label>
              <input type="time" id="edit-end-time" class="bg-white border border-gray-300 text-sm rounded-lg p-2.5 w-full">
            </div>
          </div>
        </div>

        <div>
          <h4 class="text-lg font-semibold mt-2 mb-3">狀態</h4>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <label class="flex items-center gap-2">
              <input type="radio" name="status" value="已送單" class="h-4 w-4 text-blue-600 border-gray-300" checked>
              <span>已送單</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="status" value="標準化病人安排中" class="h-4 w-4 text-blue-600 border-gray-300">
              <span>標準化病人安排中</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="status" value="已完成" class="h-4 w-4 text-green-600 border-gray-300">
              <span>已完成</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="status" value="演出取消" class="h-4 w-4 text-red-600 border-gray-300">
              <span class="text-red-700">演出取消</span>
            </label>
          </div>
        </div>

        <h4 class="text-lg font-semibold mt-4 mb-3 border-t pt-4">指派標病人員</h4>
        <div id="edit-sp-assignment-list" class="space-y-3"></div>
      </div>

      <div class="mt-1 mb-5 px-6 flex justify-end gap-3">
        <button type="button" id="cancel-edit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">取消</button>
        <button type="button" id="save-status" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">儲存變更</button>
      </div>
    </div>
  </div>

  <!-- 申請詳情 Modal -->
  <div id="details-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
    <div class="bg-gray-50 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center p-6 border-b bg-white rounded-t-lg">
        <h3 class="text-2xl font-bold text-gray-800">申請單詳情</h3>
        <button id="close-details-modal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
      </div>
      <div id="details-content-body" class="p-6 space-y-6 overflow-y-auto"></div>
    </div>
  </div>

  <!-- =========================
       JavaScript（互動邏輯）
       ========================= -->
  <script>
    // ---------------------------------------------------------
    // 0) 只有在「沒有」 Apps Script 注入時，才啟用 mock
    //    ——避免覆蓋正式的 google.script.run（關鍵修正）
    // ---------------------------------------------------------
    if (!(window.google && google.script && google.script.run)) {
      const MOCK_DB = [];
      const MOCK_SP_LIST = ["王小明","陳美麗","李大華","張雅婷","黃志強","林秀芬"];

      const mockApi = {
        _ok(cb, payload){ setTimeout(()=>cb && cb(payload), 250); return mockApi; },
        _fail(cb, msg){ setTimeout(()=>cb && cb(msg || 'MOCK 錯誤'), 250); return mockApi; },

        withSuccessHandler(cb){ mockApi._onSuccess = cb; return mockApi; },
        withFailureHandler(cb){ mockApi._onFailure = cb; return mockApi; },

        verifyAdmin(credentials){
          const ok = (credentials.username === 'admin' && credentials.password === 'admin123');
          return ok ? mockApi._ok(mockApi._onSuccess, {success:true, message:'登入成功！'})
                    : mockApi._ok(mockApi._onSuccess, {success:false, message:'帳號或密碼錯誤！'});
        },
        submitApplication(formData){
          try{
            const d = new Date();
            const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
            const id = `SP${y}${m}${day}-${Math.floor(Math.random()*100).toString().padStart(2,'0')}`;

            // 【修正點 #2】展開語法（保留你的原本邏輯）
            const newApp = {
              ...formData,
              id,
              status: '已送單',
              timestamps: { submitted: `${y}-${m}-${day} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` }
            };

            MOCK_DB.unshift(newApp);
            mockApi._ok(mockApi._onSuccess, {success:true, id, message:`申請成功！您的申請單號為 ${id}`});
          }catch(e){
            mockApi._fail(mockApi._onFailure, e.message);
          }
          return mockApi;
        },
        getApplications(){
          return mockApi._ok(mockApi._onSuccess, MOCK_DB);
        },
        updateApplication(updateData){
          const idx = MOCK_DB.findIndex(x => x.id === updateData.id);
          if (idx >= 0) {
            MOCK_DB[idx].date = updateData.date || MOCK_DB[idx].date;
            MOCK_DB[idx].startTime = updateData.startTime || MOCK_DB[idx].startTime;
            MOCK_DB[idx].endTime = updateData.endTime || MOCK_DB[idx].endTime;
            MOCK_DB[idx].status = updateData.status || MOCK_DB[idx].status;
            if (Array.isArray(updateData.spAssignments)) {
              (MOCK_DB[idx].spRequirements || []).forEach((r, i) => {
                const asg = updateData.spAssignments.find(a => Number(a.index) === (i+1));
                if (asg) r.assignedSPName = asg.name || '';
              });
            }
          }
          return mockApi._ok(mockApi._onSuccess, {success:true, message:`申請單 ${updateData.id} 已更新（MOCK）`});
        }
      };

      window.google = { script: { run: mockApi } };
      console.info('[DEV] 使用 MOCK google.script.run（正式部署時會自動改用真的 API）');
    }

    // ---------------------------------------------------------
    // 1) Tab 切換
    // ---------------------------------------------------------
    const applyTabBtn  = document.getElementById('apply-tab');
    const statusTabBtn = document.getElementById('status-tab');
    const applySec  = document.getElementById('apply');
    const statusSec = document.getElementById('status');

    applyTabBtn.addEventListener('click', () => {
      applySec.classList.remove('hidden'); statusSec.classList.add('hidden');
      applyTabBtn.classList.add('text-blue-600','border-blue-600'); 
      statusTabBtn.classList.remove('text-blue-600','border-blue-600');
    });
    statusTabBtn.addEventListener('click', () => {
      statusSec.classList.remove('hidden'); applySec.classList.add('hidden');
      statusTabBtn.classList.add('text-blue-600','border-blue-600');
      applyTabBtn.classList.remove('text-blue-600','border-blue-600');
      loadApplications();
    });

    // ---------------------------------------------------------
    // 2) 動態新增/移除 標病需求
    // ---------------------------------------------------------
    const container = document.getElementById('sp-requirements-container');
    const addBtn = document.getElementById('add-sp-requirement');
    let spIdx = 0;

    function addRequirementRow(prefill) {
      spIdx += 1;
      const row = document.createElement('div');
      row.className = 'grid grid-cols-1 md:grid-cols-6 gap-3 items-end';
      row.dataset.index = spIdx;

      row.innerHTML = `
        <div class="md:col-span-1">
          <label class="block mb-1 text-sm text-gray-700">性別</label>
          <select class="sp-gender bg-gray-50 border border-gray-300 rounded-lg p-2.5 w-full">
            <option value="">不限</option>
            <option value="男">男</option>
            <option value="女">女</option>
          </select>
        </div>
        <div class="md:col-span-1">
          <label class="block mb-1 text-sm text-gray-700">年齡條件</label>
          <input type="text" class="sp-age bg-gray-50 border border-gray-300 rounded-lg p-2.5 w-full" placeholder="如 20–35">
        </div>
        <div class="md:col-span-3">
          <label class="block mb-1 text-sm text-gray-700">情境 / 症狀</label>
          <input type="text" class="sp-condition bg-gray-50 border border-gray-300 rounded-lg p-2.5 w-full" placeholder="如：腹痛 24 小時、胸悶、跌倒後膝痛…">
        </div>
        <div class="md:col-span-1 flex gap-2">
          <button type="button" class="remove-row bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded w-full">刪除</button>
        </div>
      `;

      // prefill
      if (prefill) {
        row.querySelector('.sp-gender').value = prefill.gender || '';
        row.querySelector('.sp-age').value = prefill.age || '';
        row.querySelector('.sp-condition').value = prefill.condition || '';
      }

      row.querySelector('.remove-row').addEventListener('click', () => {
        row.remove();
      });

      container.appendChild(row);
    }
    addBtn.addEventListener('click', () => addRequirementRow());
    // 預設一列
    addRequirementRow();

    // ---------------------------------------------------------
    // 3) 送出申請
    // ---------------------------------------------------------
    const submitBtn = document.getElementById('submit-application');

    function collectFormData() {
      const department = document.getElementById('department').value.trim();
      const applicant  = document.getElementById('applicant').value.trim();
      const phone      = document.getElementById('phone').value.trim();
      const email      = document.getElementById('email').value.trim();
      const reason     = document.getElementById('reason').value.trim();

      const date       = document.getElementById('performance-date').value;
      const startTime  = document.getElementById('start-time').value;
      const endTime    = document.getElementById('end-time').value;
      const location   = document.getElementById('location').value.trim();
      const audience   = document.getElementById('audience').value.trim();
      const teachingActivity = document.getElementById('teaching-activity').value.trim();

      const spRequirements = Array.from(container.querySelectorAll('[data-index]')).map((row, idx) => ({
        index: idx + 1,
        gender: row.querySelector('.sp-gender').value,
        age: row.querySelector('.sp-age').value.trim(),
        condition: row.querySelector('.sp-condition').value.trim()
      }));

      return {
        department, applicant, phone, email, reason,
        date, startTime, endTime, location, audience,
        teachingActivity,
        spRequirements
      };
    }

    submitBtn.addEventListener('click', () => {
      // 基本驗證（維持你的最小邏輯，不做版面改動）
      const fd = collectFormData();
      if (!fd.department || !fd.applicant || !fd.phone || !fd.email || !fd.date || !fd.startTime || !fd.endTime || !fd.location || !fd.audience) {
        alert('請完整填寫必填欄位。');
        return; // 僅在驗證失敗時早退（避免誤中斷）
      }

      submitBtn.disabled = true;
      submitBtn.textContent = '送出中…';

      google.script.run
        .withSuccessHandler((res) => {
          submitBtn.disabled = false;
          submitBtn.textContent = '送出申請';
          if (res && res.success) {
            alert(res.message || '申請已送出！');
            // 清空（簡單做法）
            document.getElementById('department').value = '';
            document.getElementById('applicant').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('email').value = '';
            document.getElementById('reason').value = '';
            document.getElementById('performance-date').value = '';
            document.getElementById('start-time').value = '';
            document.getElementById('end-time').value = '';
            document.getElementById('location').value = '';
            document.getElementById('audience').value = '';
            document.getElementById('teaching-activity').value = '';
            container.innerHTML = '';
            spIdx = 0;
            addRequirementRow();
          } else {
            alert(res && res.message ? res.message : '送出失敗');
          }
        })
        .withFailureHandler((err) => {
          submitBtn.disabled = false;
          submitBtn.textContent = '送出申請';
          alert('送出失敗：' + (err?.message || err || '未知錯誤'));
        })
        .submitApplication(fd);
    });

    // ---------------------------------------------------------
    // 4) 申請列表（查詢）
    // ---------------------------------------------------------
    const listEl = document.getElementById('applications-list');
    const emptyEl = document.getElementById('applications-empty');
    const refreshBtn = document.getElementById('refresh-list');

    function renderApplicationItem(app) {
      const li = document.createElement('div');
      li.className = 'py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3';

      const left = document.createElement('div');
      left.innerHTML = `
        <div class="font-semibold text-gray-800">${app.id || '(尚未分配單號)'}</div>
        <div class="text-sm text-gray-600 mt-0.5">
          ${app.department || ''} / ${app.applicant || ''} / ${app.phone || ''} / ${app.email || ''}
        </div>
        <div class="text-sm text-gray-600 mt-0.5">
          ${app.date || ''} ${app.startTime || ''}–${app.endTime || ''}＠${app.location || ''}
        </div>
        <div class="text-xs text-gray-500 mt-0.5">狀態：${app.status || '已送單'}</div>
      `;

      const right = document.createElement('div');
      right.className = 'flex gap-2';
      const detailsBtn = document.createElement('button');
      detailsBtn.className = 'px-3 py-1.5 rounded border text-sm hover:bg-gray-50';
      detailsBtn.textContent = '詳情';
      const editBtn = document.createElement('button');
      editBtn.className = 'px-3 py-1.5 rounded border text-sm hover:bg-gray-50';
      editBtn.textContent = '編輯';

      detailsBtn.addEventListener('click', () => openDetailsModal(app));
      editBtn.addEventListener('click', () => openEditModal(app));

      right.append(detailsBtn, editBtn);
      li.append(left, right);
      return li;
    }

    function loadApplications() {
      listEl.innerHTML = '<div class="py-8 flex justify-center"><div class="loader"></div></div>';
      emptyEl.classList.add('hidden');

      google.script.run
        .withSuccessHandler((data) => {
          listEl.innerHTML = '';
          if (!data || (Array.isArray(data) && data.length === 0) || (data.data && data.data.length === 0)) {
            emptyEl.classList.remove('hidden');
            return;
          }
          const rows = Array.isArray(data) ? data : (data.data || []);
          rows.forEach(app => listEl.appendChild(renderApplicationItem(app)));
        })
        .withFailureHandler((err) => {
          listEl.innerHTML = '';
          emptyEl.classList.remove('hidden');
          console.error(err);
        })
        .getApplications();
    }
    refreshBtn.addEventListener('click', loadApplications);

    // ---------------------------------------------------------
    // 5) 詳情 Modal
    // ---------------------------------------------------------
    const detailsModal = document.getElementById('details-modal');
    const detailsBody  = document.getElementById('details-content-body');
    const closeDetails = document.getElementById('close-details-modal');

    function openDetailsModal(app) {
      const sp = (app.spRequirements || []).map((r, i) =>
        `<li class="text-sm text-gray-700">#${i+1} 性別：${r.gender || '不限'}；年齡：${r.age || '—'}；情境：${r.condition || '—'}；指派：${r.assignedSPName || '—'}</li>`
      ).join('');

      detailsBody.innerHTML = `
        <div class="space-y-2">
          <div><span class="font-semibold">單號：</span>${app.id || ''}</div>
          <div><span class="font-semibold">單位／申請人：</span>${app.department || ''}／${app.applicant || ''}</div>
          <div><span class="font-semibold">連絡：</span>${app.phone || ''}；${app.email || ''}</div>
          <div><span class="font-semibold">時間地點：</span>${app.date || ''} ${app.startTime || ''}–${app.endTime || ''}＠${app.location || ''}</div>
          <div><span class="font-semibold">受教對象：</span>${app.audience || ''}</div>
          <div><span class="font-semibold">教學活動：</span>${app.teachingActivity || ''}</div>
          <div><span class="font-semibold">狀態：</span>${app.status || '已送單'}</div>
          <div><span class="font-semibold">申請理由：</span>${app.reason || ''}</div>
        </div>
        <div class="mt-4">
          <div class="font-semibold mb-2">需求列表</div>
          <ul class="list-disc ml-5 space-y-1">${sp || '<li class="text-sm text-gray-500">（無）</li>'}</ul>
        </div>
      `;

      detailsModal.classList.remove('hidden'); requestAnimationFrame(()=> detailsModal.style.opacity = '1');
    }
    closeDetails.addEventListener('click', () => { detailsModal.style.opacity='0'; setTimeout(()=>detailsModal.classList.add('hidden'), 180); });

    // ---------------------------------------------------------
    // 6) 編輯 Modal（管理用）
    // ---------------------------------------------------------
    const editModal = document.getElementById('edit-modal');
    const closeEdit = document.getElementById('close-edit-modal');
    const cancelEdit = document.getElementById('cancel-edit');
    const saveStatus = document.getElementById('save-status');
    const editDate   = document.getElementById('edit-date');
    const editStart  = document.getElementById('edit-start-time');
    const editEnd    = document.getElementById('edit-end-time');
    const editSPWrap = document.getElementById('edit-sp-assignment-list');

    let editingApp = null;

    function openEditModal(app) {
      editingApp = app;
      editDate.value = app.date || '';
      editStart.value = app.startTime || '';
      editEnd.value = app.endTime || '';

      // 狀態單選
      document.querySelectorAll('#edit-modal input[name="status"]').forEach(r => {
        r.checked = (r.value === (app.status || '已送單'));
      });

      // 指派人員列表
      editSPWrap.innerHTML = '';
      (app.spRequirements || []).forEach((r, i) => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 items-end';
        row.innerHTML = `
          <div class="md:col-span-1">
            <div class="text-sm text-gray-500 mb-1">#${i+1} 性別=${r.gender || '不限'}；年齡=${r.age || '—'}</div>
            <div class="text-sm text-gray-500">情境：${r.condition || '—'}</div>
          </div>
          <div class="md:col-span-2">
            <label class="block mb-1 text-sm text-gray-700">指派標病人員</label>
            <input type="text" class="assign-name bg-white border border-gray-300 rounded-lg p-2.5 w-full" placeholder="輸入姓名" value="${r.assignedSPName || ''}">
          </div>
        `;
        row.dataset.index = (i + 1);
        editSPWrap.appendChild(row);
      });

      editModal.classList.remove('hidden'); requestAnimationFrame(()=> editModal.style.opacity = '1');
    }

    function closeEditModalNow() { editModal.style.opacity='0'; setTimeout(()=>editModal.classList.add('hidden'), 180); }
    [closeEdit, cancelEdit].forEach(btn => btn.addEventListener('click', closeEditModalNow));

    saveStatus.addEventListener('click', () => {
      if (!editingApp) return;
      const payload = {
        id: editingApp.id,
        date: editDate.value || '',
        startTime: editStart.value || '',
        endTime: editEnd.value || '',
        status: document.querySelector('#edit-modal input[name="status"]:checked')?.value || '已送單',
        spAssignments: Array.from(editSPWrap.querySelectorAll('[data-index]')).map(row => ({
          index: Number(row.dataset.index),
          name: row.querySelector('.assign-name').value.trim()
        }))
      };

      saveStatus.disabled = true; saveStatus.textContent = '儲存中…';
      google.script.run
        .withSuccessHandler((res) => {
          saveStatus.disabled = false; saveStatus.textContent = '儲存變更';
          if (res && res.success) {
            alert(res.message || '已更新');
            closeEditModalNow();
            loadApplications();
          } else {
            alert(res && res.message ? res.message : '更新失敗');
          }
        })
        .withFailureHandler((err) => {
          saveStatus.disabled = false; saveStatus.textContent = '儲存變更';
          alert('更新失敗：' + (err?.message || err || '未知錯誤'));
        })
        .updateApplication(payload);
    });

    // ---------------------------------------------------------
    // 7) 管理員登入（簡易示範）
    // ---------------------------------------------------------
    const adminBtn = document.getElementById('admin-login-btn');
    adminBtn.addEventListener('click', () => {
      const username = prompt('請輸入帳號：');
      if (username === null) return;
      const password = prompt('請輸入密碼：');
      if (password === null) return;

      google.script.run
        .withSuccessHandler((res) => {
          if (res && res.success) {
            alert('登入成功！');
            // 這裡可做權限控管，例如顯示「編輯」按鈕等
          } else {
            alert(res && res.message ? res.message : '登入失敗');
          }
        })
        .withFailureHandler((err) => {
          alert('登入錯誤：' + (err?.message || err || '未知錯誤'));
        })
        .verifyAdmin({ username, password });
    });

    // 預設載入列表（貼心一點）
    // loadApplications(); // 由切到「申請進度查詢」時自動載入
  </script>
</body>
</html>
