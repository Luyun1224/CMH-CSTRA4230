<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奇美醫院標準化病人申請作業系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-overlay {
            position: absolute; inset: 0; background-color: rgba(255, 255, 255, 0.7);
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl relative">
        <header class="text-center pt-8 mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 tracking-wide">奇美醫院標準化病人申請作業系統</h1>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab" role="tablist">
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg text-blue-600 border-blue-600" id="apply-tab" type="button" role="tab" aria-controls="apply" aria-selected="true">新申請案填寫</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" id="status-tab" type="button" role="tab" aria-controls="status" aria-selected="false">申請進度查詢</button>
                </li>
            </ul>
        </div>

        <div id="myTabContent">
            <div class="tab-content active" id="apply" role="tabpanel" aria-labelledby="apply-tab">
                <form id="sp-application-form">
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm border border-gray-200 h-fit">
                            <div class="flex items-center gap-3 mb-6"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div><h2 class="text-xl font-bold text-gray-700">一、基本資料</h2></div>
                            <div class="space-y-6">
                                <div><label for="department" class="block mb-2 text-sm font-medium text-gray-900">申請單位</label><input type="text" id="department" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="例如：內科部" required></div>
                                <div><label for="applicant" class="block mb-2 text-sm font-medium text-gray-900">申請人</label><input type="text" id="applicant" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="王大明" required></div>
                                <div><label for="phone" class="block mb-2 text-sm font-medium text-gray-900">連絡電話</label><input type="tel" id="phone" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="0912-345-678 或 分機 12345" required></div>
                                <div><label for="email" class="block mb-2 text-sm font-medium text-gray-900">Email</label><input type="email" id="email" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="example@chimei.org.tw" required></div>
                                <div><label for="reason" class="block mb-2 text-sm font-medium text-gray-900">申請標準化病人原因</label><textarea id="reason" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="請簡述本次申請原因，例如：PGY OSCE 測驗" required></textarea></div>
                            </div>
                        </div>
                        <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                             <div class="flex items-center gap-3 mb-6"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div><h2 class="text-xl font-bold text-gray-700">二、標準化病人申請資料</h2></div>
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <div><label for="performance-date" class="block mb-2 text-sm font-medium text-gray-900">預計演出日期</label><input type="date" id="performance-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required></div>
                                    <div class="flex items-end gap-2"><div class="flex-1"><label for="start-time" class="block mb-2 text-sm font-medium text-gray-900">演出開始時間</label><input type="time" id="start-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required></div><span class="text-gray-500 pb-2.5">至</span><div class="flex-1"><label for="end-time" class="block mb-2 text-sm font-medium text-gray-900">演出結束時間</label><input type="time" id="end-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required></div></div>
                                    <div><label for="location" class="block mb-2 text-sm font-medium text-gray-900">演出地點</label><input type="text" id="location" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="臨床技能中心" required></div>
                                    <div><label for="audience" class="block mb-2 text-sm font-medium text-gray-900">測驗對象</label><input type="text" id="audience" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="例如：PGY、UGY" required></div>
                                </div>
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-900">標準化病人需求數</label>
                                    <div id="sp-requirements-container" class="space-y-4"></div>
                                    <button type="button" id="add-sp-requirement" class="mt-4 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>增列一位標病條件</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end mt-8">
                        <button type="submit" id="submit-btn" class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-base px-8 py-3 text-center inline-flex items-center gap-2 disabled:bg-gray-400">送出申請<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg></button>
                    </div>
                </form>
            </div>
            <div class="tab-content p-4" id="status" role="tabpanel" aria-labelledby="status-tab">
                 <div class="bg-white p-6 rounded-lg shadow-md relative min-h-[300px]">
                    <div id="loading-overlay" class="loading-overlay hidden"><div class="loader"></div></div>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">查詢您的申請紀錄</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <input type="text" id="search-input" class="flex-grow bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="請輸入申請單號、單位或申請人姓名查詢...">
                        <button id="search-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-6 py-2.5">查詢</button>
                    </div>
                    <div class="relative overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th scope="col" class="px-6 py-3">申請單號</th><th scope="col" class="px-6 py-3">申請人</th><th scope="col" class="px-6 py-3">演出日期</th><th scope="col" class="px-6 py-3">進度</th><th scope="col" class="px-6 py-3">操作</th></tr></thead>
                            <tbody id="status-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="text-center py-6 text-sm text-gray-500 mt-8">
        <p>&copy; 奇美醫療財團法人奇美醫院 臨床技能中心</p>
    </footer>

    <script>
        function initializeAppLogic() {
            const submitBtn = document.getElementById('submit-btn');
            const container = document.getElementById('sp-requirements-container');
            const addButton = document.getElementById('add-sp-requirement');
            const form = document.getElementById('sp-application-form');
            let spCount = 0;

            function addSpRequirement() {
                spCount++;
                const requirementDiv = document.createElement('div');
                requirementDiv.className = 'p-4 border border-gray-200 rounded-lg grid grid-cols-1 sm:grid-cols-3 gap-4 items-end relative';
                requirementDiv.innerHTML = `<div class="font-semibold text-gray-600 sm:col-span-3">標病 ${spCount}</div><div><label class="block mb-1 text-xs font-medium text-gray-700">性別</label><select class="sp-gender bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"><option selected value="">請選擇</option><option value="男">男</option><option value="女">女</option><option value="不拘">不拘</option></select></div><div><label class="block mb-1 text-xs font-medium text-gray-700">年齡</label><input type="text" class="sp-age bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2" placeholder="例如：40-50歲"></div><div><label class="block mb-1 text-xs font-medium text-gray-700">演出教案/條件</label><input type="text" class="sp-condition bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2" placeholder="例如：腹痛教案"></div><button type="button" class="remove-sp-requirement absolute top-2 right-2 text-gray-400 hover:text-red-500">&times;</button>`;
                container.appendChild(requirementDiv);
            }
            addSpRequirement();
            addButton.addEventListener('click', addSpRequirement);
            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-sp-requirement')) {
                    if (container.children.length > 1) e.target.parentElement.remove();
                    else alert("至少需保留一項標病需求。");
                }
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = '送出中...';
                const spRequirements = [];
                const requirementNodes = container.querySelectorAll('.p-4');
                let hasEmptyFields = false;
                requirementNodes.forEach(node => {
                    const gender = node.querySelector('.sp-gender').value;
                    const age = node.querySelector('.sp-age').value;
                    const condition = node.querySelector('.sp-condition').value;
                    if (!gender || !age.trim() || !condition.trim()) hasEmptyFields = true;
                    spRequirements.push({ gender, age, condition });
                });

                if (hasEmptyFields) {
                    alert('標病需求的欄位(性別、年齡、條件)皆為必填。');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '送出申請';
                    return;
                }

                const payloadForGas = {
                    unit: document.getElementById('department').value,
                    applicantName: document.getElementById('applicant').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    activityTitle: document.getElementById('reason').value,
                    activityDate: document.getElementById('performance-date').value,
                    activityTimeStart: document.getElementById('start-time').value,
                    activityTimeEnd: document.getElementById('end-time').value,
                    location: document.getElementById('location').value,
                    patientGroup: document.getElementById('audience').value,
                    details: spRequirements.map(req => ({
                        spGender: req.gender,
                        spAgeRange: req.age,
                        spSkill: req.condition,
                    })),
                };
                
                google.script.run
                    .withSuccessHandler(response => {
                        alert(response.message);
                        if (response.success) form.reset();
                        submitBtn.disabled = false;
                        submitBtn.textContent = '送出申請';
                    })
                    .withFailureHandler(err => {
                        alert("送出失敗: " + err);
                        submitBtn.disabled = false;
                        submitBtn.textContent = '送出申請';
                    })
                    .submitApplication(payloadForGas);
            });
            // Tab切換邏輯
            const tabs = document.querySelectorAll('#myTab button');
            const tabContents = document.querySelectorAll('#myTabContent .tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    tabs.forEach(t => t.classList.remove('text-blue-600', 'border-blue-600'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    this.classList.add('text-blue-600', 'border-blue-600');
                    document.getElementById(this.getAttribute('aria-controls')).classList.add('active');
                    if (this.id === 'status-tab') fetchApplications();
                });
            });
            // 查詢功能
            const searchBtn = document.getElementById('search-btn');
            const searchInput = document.getElementById('search-input');
            const statusTableBody = document.getElementById('status-table-body');
            const loadingOverlay = document.getElementById('loading-overlay');
            function fetchApplications(){
                loadingOverlay.classList.remove('hidden');
                google.script.run
                    .withSuccessHandler(response => {
                        if(response.success){
                            renderStatusTable(response.data);
                        } else {
                            alert('查詢失敗：' + response.message);
                        }
                        loadingOverlay.classList.add('hidden');
                    })
                    .withFailureHandler(err => {
                        alert('查詢錯誤：' + err);
                        loadingOverlay.classList.add('hidden');
                    })
                    .getApplications({keyword: searchInput.value});
            }
            searchBtn.addEventListener('click', fetchApplications);
            searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') fetchApplications(); });
            function renderStatusTable(data) {
                statusTableBody.innerHTML = '';
                if (!data || data.length === 0) {
                    statusTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500">查無資料</td></tr>`;
                    return;
                }
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `<th scope="row" class="px-6 py-4 font-medium text-gray-900">${item.id}</th><td class="px-6 py-4">${item.unit} - ${item.applicantName}</td><td class="px-6 py-4">${item.activityDate}</td><td class="px-6 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${item.status}</span></td><td class="px-6 py-4"><a href="#" class="font-medium text-blue-600 hover:underline">詳情</a></td>`;
                    statusTableBody.appendChild(row);
                });
            }
        }
        document.addEventListener('DOMContentLoaded', initializeAppLogic);
    </script>
</body>
</html>
