
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>教具申請管理系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
  <div class="container mx-auto px-4 py-8 relative">
    <div class="absolute top-8 right-8 text-right text-sm text-gray-600 space-y-1">
      <button id="adminLoginBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">管理者登入</button>
      <div id="admin-info" class="hidden">
        <p class="font-bold text-gray-800">管理員</p>
        <p id="adminStatusText" class="text-green-700 font-bold text-xs">已取得管理權限</p>
      </div>
    </div>

    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">教具申請管理系統</h1>
      <p class="text-gray-600">申請教具並追蹤申請進度</p>
    </div>

    <div class="flex justify-center mb-8 space-x-4">
      <button id="applyBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
        📝 新增申請
      </button>
      <button id="statusBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-medium transition-colors">
        📊 查看狀態
      </button>
    </div>

    <!-- 申請表單 -->
    <div id="applicationForm" class="max-w-4xl mx-auto bg-white rounded-xl shadow-md p-6 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">申請單位</label>
          <input id="department" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">申請人</label>
          <input id="applicant" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">職稱</label>
          <input id="position" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">聯繫方式</label>
          <input id="contact" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">信箱</label>
          <input id="email" type="email" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">教具品名規格</label>
          <input id="equipmentSpec" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">申請數量</label>
          <input id="quantity" type="number" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">教學頻率</label>
          <input id="frequency" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">預期效益</label>
          <textarea id="expectedBenefit" class="w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">教學對象</label>
          <input id="targetAudience" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">附件（檔名）</label>
          <input id="attachments" type="text" placeholder="例：計畫書.pdf" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
      </div>
      <button id="submitButton" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">🚀 提交申請</button>
    </div>

    <!-- 狀態檢視 -->
    <div id="statusView" class="max-w-6xl mx-auto bg-white rounded-xl shadow-md p-6 hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">申請狀態查詢</h2>
      <div class="border-b pb-4 mb-4">
        <div class="flex flex-col sm:flex-row gap-4">
          <input id="searchInput" type="text" placeholder="輸入申請人或教具名稱關鍵字" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg">🔍 搜尋</button>
        </div>
      </div>
      <div id="applicationsList" class="space-y-4"></div>
    </div>

    <div id="successMessage" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg hidden fade-in">✅ 申請提交成功！</div>
    <div id="errorMessage" class="fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg hidden fade-in">❌ 發生錯誤！</div>

    <!-- 管理者登入 Modal -->
    <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4 shadow-lg" onclick="event.stopPropagation()">
        <h3 class="text-xl font-semibold mb-4">管理者登入</h3>
        <div class="relative mb-4">
          <input type="password" id="adminPassword" placeholder="請輸入管理密碼" class="w-full px-4 py-3 border border-gray-300 rounded-lg pr-10">
        </div>
        <div class="flex justify-end gap-3">
          <button id="cancelAdminLogin" class="px-4 py-2 rounded-lg border">取消</button>
          <button id="confirmAdminLogin" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">登入</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== 設定 ======
    const GOOGLE_APPS_SCRIPT_URL = 'PUT_YOUR_EXEC_URL_HERE'; // 例：https://script.google.com/macros/s/XXXXX/exec

    // ====== 共同狀態 ======
    let isAdmin = false;
    let allApplications = [];

    // ====== 元素 ======
    const applyBtn = document.getElementById('applyBtn');
    const statusBtn = document.getElementById('statusBtn');
    const applicationForm = document.getElementById('applicationForm');
    const statusView = document.getElementById('statusView');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    const department = document.getElementById('department');
    const applicant = document.getElementById('applicant');
    const position = document.getElementById('position');
    const contact = document.getElementById('contact');
    const email = document.getElementById('email');
    const equipmentSpec = document.getElementById('equipmentSpec');
    const quantity = document.getElementById('quantity');
    const frequency = document.getElementById('frequency');
    const expectedBenefit = document.getElementById('expectedBenefit');
    const targetAudience = document.getElementById('targetAudience');
    const attachments = document.getElementById('attachments');
    const submitButton = document.getElementById('submitButton');

    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');

    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminModal = document.getElementById('adminModal');
    const confirmAdminLogin = document.getElementById('confirmAdminLogin');
    const cancelAdminLogin = document.getElementById('cancelAdminLogin');
    const adminPasswordInput = document.getElementById('adminPassword');

    // ====== 工具 ======
    function showMessage(element, message) {
      element.textContent = message;
      element.classList.remove('hidden');
      element.classList.add('fade-in');
      setTimeout(() => {
        element.classList.add('hidden');
        element.classList.remove('fade-in');
      }, 4000);
    }

    // ====== View 切換 ======
    function showView(view) {
      if (view === 'apply') {
        applicationForm.classList.remove('hidden');
        statusView.classList.add('hidden');
        return;
      }
      // 狀態頁
      applicationForm.classList.add('hidden');
      statusView.classList.remove('hidden');
      // 重要：用 POST 拿資料（避開 CORS 預檢與 GET 的跨域限制）
      fetchAndDisplayApplications();
    }

    // ====== 送單 ======
    submitButton.addEventListener('click', async () => {
      submitButton.disabled = true;
      submitButton.textContent = '處理中…';

      const formData = {
        action: 'submit_form',
        department: department.value.trim(),
        applicant: applicant.value.trim(),
        position: position.value.trim(),
        contact: contact.value.trim(),
        email: email.value.trim(),
        equipmentSpec: equipmentSpec.value.trim(),
        quantity: quantity.value,
        frequency: frequency.value.trim(),
        expectedBenefit: expectedBenefit.value.trim(),
        targetAudience: targetAudience.value.trim(),
        attachments: attachments.value.trim()
      };

      try {
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          // 不帶 Content-Type，避免預檢
          body: JSON.stringify(formData)
        });
        const result = await res.json();
        if (result.result === 'success') {
          showMessage(successMessage, '申請已成功送出！');
          // 清空表單
          [department, applicant, position, contact, email, equipmentSpec, quantity, frequency, expectedBenefit, targetAudience, attachments].forEach(el => el.value = '');
        } else {
          showMessage(errorMessage, result.message || '提交失敗');
        }
      } catch (err) {
        console.error(err);
        showMessage(errorMessage, '提交失敗，請查看主控台或 Apps Script 日誌');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = '🚀 提交申請';
      }
    });

    // ====== 讀資料（POST：action=list） ======
    async function fetchAndDisplayApplications(searchTerm = '') {
      try {
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'list' }) // 後端 doPost 支援
        });
        const result = await res.json();
        if (result.result === 'success') {
          allApplications = result.data || [];
          displayApplications(searchTerm);
        } else {
          showMessage(errorMessage, result.message || '讀取資料失敗');
        }
      } catch (err) {
        console.error(err);
        showMessage(errorMessage, '無法載入資料');
      }
    }

    // ====== 渲染列表 ======
    function displayApplications(searchTerm = '') {
      const container = document.getElementById('applicationsList');
      let filtered = allApplications;

      if (searchTerm) {
        const q = searchTerm.toLowerCase();
        filtered = allApplications.filter(app =>
          String(app['申請人'] || '').toLowerCase().includes(q) ||
          String(app['教具品名規格'] || '').toLowerCase().includes(q)
        );
      }

      if (!filtered.length) {
        container.innerHTML = `<div class="p-8 text-center text-gray-500">目前沒有資料</div>`;
        return;
      }

      container.innerHTML = filtered.map(app => {
        const status = app['狀態'] || '未知';
        const id = app['申請編號'] || app['id'] || '';
        const created = app['時間戳記'] ? new Date(app['時間戳記']).toLocaleString() : '';

        return `<div class="border border-gray-200 rounded-xl p-4">
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold">${app['教具品名規格'] || '(未填)'}</div>
            <div class="text-sm px-3 py-1 rounded-full bg-gray-100">${status}</div>
          </div>
          <div class="mt-2 text-sm text-gray-600">
            <div>申請人：${app['申請人'] || ''}</div>
            <div>申請編號：${id}</div>
            <div>送出時間：${created}</div>
          </div>
        </div>`;
      }).join('');
    }

    // ====== 搜尋 ======
    searchBtn.addEventListener('click', () => displayApplications(searchInput.value));
    searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchBtn.click(); });

    // ====== 管理者登入（POST：verify_password） ======
    adminLoginBtn.addEventListener('click', () => adminModal.classList.remove('hidden'));
    cancelAdminLogin.addEventListener('click', () => adminModal.classList.add('hidden'));
    confirmAdminLogin.addEventListener('click', async () => {
      try {
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'verify_password', password: adminPasswordInput.value })
        });
        const result = await res.json();
        if (result.result === 'success') {
          isAdmin = true;
          adminModal.classList.add('hidden');
          showMessage(successMessage, '管理者登入成功');
        } else {
          showMessage(errorMessage, result.message || '密碼錯誤');
        }
      } catch (e) {
        console.error(e);
        showMessage(errorMessage, '登入失敗');
      }
    });

    // 預設停在申請頁
    showView('apply');
  </script>
</body>
</html>
