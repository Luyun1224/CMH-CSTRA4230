
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•™å…·ç”³è«‹ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
  <div class="container mx-auto px-4 py-8 relative">
    <div class="absolute top-8 right-8 text-right text-sm text-gray-600 space-y-1">
      <button id="adminLoginBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">ç®¡ç†è€…ç™»å…¥</button>
      <div id="admin-info" class="hidden">
        <p class="font-bold text-gray-800">ç®¡ç†å“¡</p>
        <p id="adminStatusText" class="text-green-700 font-bold text-xs">å·²å–å¾—ç®¡ç†æ¬Šé™</p>
      </div>
    </div>

    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">æ•™å…·ç”³è«‹ç®¡ç†ç³»çµ±</h1>
      <p class="text-gray-600">ç”³è«‹æ•™å…·ä¸¦è¿½è¹¤ç”³è«‹é€²åº¦</p>
    </div>

    <div class="flex justify-center mb-8 space-x-4">
      <button id="applyBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
        ğŸ“ æ–°å¢ç”³è«‹
      </button>
      <button id="statusBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-medium transition-colors">
        ğŸ“Š æŸ¥çœ‹ç‹€æ…‹
      </button>
    </div>

    <!-- ç”³è«‹è¡¨å–® -->
    <div id="applicationForm" class="max-w-4xl mx-auto bg-white rounded-xl shadow-md p-6 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">ç”³è«‹å–®ä½</label>
          <input id="department" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">ç”³è«‹äºº</label>
          <input id="applicant" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">è·ç¨±</label>
          <input id="position" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">è¯ç¹«æ–¹å¼</label>
          <input id="contact" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">ä¿¡ç®±</label>
          <input id="email" type="email" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">æ•™å…·å“åè¦æ ¼</label>
          <input id="equipmentSpec" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">ç”³è«‹æ•¸é‡</label>
          <input id="quantity" type="number" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">æ•™å­¸é »ç‡</label>
          <input id="frequency" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">é æœŸæ•ˆç›Š</label>
          <textarea id="expectedBenefit" class="w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">æ•™å­¸å°è±¡</label>
          <input id="targetAudience" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">é™„ä»¶ï¼ˆæª”åï¼‰</label>
          <input id="attachments" type="text" placeholder="ä¾‹ï¼šè¨ˆç•«æ›¸.pdf" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
      </div>
      <button id="submitButton" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">ğŸš€ æäº¤ç”³è«‹</button>
    </div>

    <!-- ç‹€æ…‹æª¢è¦– -->
    <div id="statusView" class="max-w-6xl mx-auto bg-white rounded-xl shadow-md p-6 hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ç”³è«‹ç‹€æ…‹æŸ¥è©¢</h2>
      <div class="border-b pb-4 mb-4">
        <div class="flex flex-col sm:flex-row gap-4">
          <input id="searchInput" type="text" placeholder="è¼¸å…¥ç”³è«‹äººæˆ–æ•™å…·åç¨±é—œéµå­—" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg">ğŸ” æœå°‹</button>
        </div>
      </div>
      <div id="applicationsList" class="space-y-4"></div>
    </div>

    <div id="successMessage" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg hidden fade-in">âœ… ç”³è«‹æäº¤æˆåŠŸï¼</div>
    <div id="errorMessage" class="fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg hidden fade-in">âŒ ç™¼ç”ŸéŒ¯èª¤ï¼</div>

    <!-- ç®¡ç†è€…ç™»å…¥ Modal -->
    <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4 shadow-lg" onclick="event.stopPropagation()">
        <h3 class="text-xl font-semibold mb-4">ç®¡ç†è€…ç™»å…¥</h3>
        <div class="relative mb-4">
          <input type="password" id="adminPassword" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" class="w-full px-4 py-3 border border-gray-300 rounded-lg pr-10">
        </div>
        <div class="flex justify-end gap-3">
          <button id="cancelAdminLogin" class="px-4 py-2 rounded-lg border">å–æ¶ˆ</button>
          <button id="confirmAdminLogin" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">ç™»å…¥</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== è¨­å®š ======
    const GOOGLE_APPS_SCRIPT_URL = 'PUT_YOUR_EXEC_URL_HERE'; // ä¾‹ï¼šhttps://script.google.com/macros/s/XXXXX/exec

    // ====== å…±åŒç‹€æ…‹ ======
    let isAdmin = false;
    let allApplications = [];

    // ====== å…ƒç´  ======
    const applyBtn = document.getElementById('applyBtn');
    const statusBtn = document.getElementById('statusBtn');
    const applicationForm = document.getElementById('applicationForm');
    const statusView = document.getElementById('statusView');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    const department = document.getElementById('department');
    const applicant = document.getElementById('applicant');
    const position = document.getElementById('position');
    const contact = document.getElementById('contact');
    const email = document.getElementById('email');
    const equipmentSpec = document.getElementById('equipmentSpec');
    const quantity = document.getElementById('quantity');
    const frequency = document.getElementById('frequency');
    const expectedBenefit = document.getElementById('expectedBenefit');
    const targetAudience = document.getElementById('targetAudience');
    const attachments = document.getElementById('attachments');
    const submitButton = document.getElementById('submitButton');

    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');

    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminModal = document.getElementById('adminModal');
    const confirmAdminLogin = document.getElementById('confirmAdminLogin');
    const cancelAdminLogin = document.getElementById('cancelAdminLogin');
    const adminPasswordInput = document.getElementById('adminPassword');

    // ====== å·¥å…· ======
    function showMessage(element, message) {
      element.textContent = message;
      element.classList.remove('hidden');
      element.classList.add('fade-in');
      setTimeout(() => {
        element.classList.add('hidden');
        element.classList.remove('fade-in');
      }, 4000);
    }

    // ====== View åˆ‡æ› ======
    function showView(view) {
      if (view === 'apply') {
        applicationForm.classList.remove('hidden');
        statusView.classList.add('hidden');
        return;
      }
      // ç‹€æ…‹é 
      applicationForm.classList.add('hidden');
      statusView.classList.remove('hidden');
      // é‡è¦ï¼šç”¨ POST æ‹¿è³‡æ–™ï¼ˆé¿é–‹ CORS é æª¢èˆ‡ GET çš„è·¨åŸŸé™åˆ¶ï¼‰
      fetchAndDisplayApplications();
    }

    // ====== é€å–® ======
    submitButton.addEventListener('click', async () => {
      submitButton.disabled = true;
      submitButton.textContent = 'è™•ç†ä¸­â€¦';

      const formData = {
        action: 'submit_form',
        department: department.value.trim(),
        applicant: applicant.value.trim(),
        position: position.value.trim(),
        contact: contact.value.trim(),
        email: email.value.trim(),
        equipmentSpec: equipmentSpec.value.trim(),
        quantity: quantity.value,
        frequency: frequency.value.trim(),
        expectedBenefit: expectedBenefit.value.trim(),
        targetAudience: targetAudience.value.trim(),
        attachments: attachments.value.trim()
      };

      try {
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          // ä¸å¸¶ Content-Typeï¼Œé¿å…é æª¢
          body: JSON.stringify(formData)
        });
        const result = await res.json();
        if (result.result === 'success') {
          showMessage(successMessage, 'ç”³è«‹å·²æˆåŠŸé€å‡ºï¼');
          // æ¸…ç©ºè¡¨å–®
          [department, applicant, position, contact, email, equipmentSpec, quantity, frequency, expectedBenefit, targetAudience, attachments].forEach(el => el.value = '');
        } else {
          showMessage(errorMessage, result.message || 'æäº¤å¤±æ•—');
        }
      } catch (err) {
        console.error(err);
        showMessage(errorMessage, 'æäº¤å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¸»æ§å°æˆ– Apps Script æ—¥èªŒ');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'ğŸš€ æäº¤ç”³è«‹';
      }
    });

    // ====== è®€è³‡æ–™ï¼ˆPOSTï¼šaction=listï¼‰ ======
    async function fetchAndDisplayApplications(searchTerm = '') {
      try {
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'list' }) // å¾Œç«¯ doPost æ”¯æ´
        });
        const result = await res.json();
        if (result.result === 'success') {
          allApplications = result.data || [];
          displayApplications(searchTerm);
        } else {
          showMessage(errorMessage, result.message || 'è®€å–è³‡æ–™å¤±æ•—');
        }
      } catch (err) {
        console.error(err);
        showMessage(errorMessage, 'ç„¡æ³•è¼‰å…¥è³‡æ–™');
      }
    }

    // ====== æ¸²æŸ“åˆ—è¡¨ ======
    function displayApplications(searchTerm = '') {
      const container = document.getElementById('applicationsList');
      let filtered = allApplications;

      if (searchTerm) {
        const q = searchTerm.toLowerCase();
        filtered = allApplications.filter(app =>
          String(app['ç”³è«‹äºº'] || '').toLowerCase().includes(q) ||
          String(app['æ•™å…·å“åè¦æ ¼'] || '').toLowerCase().includes(q)
        );
      }

      if (!filtered.length) {
        container.innerHTML = `<div class="p-8 text-center text-gray-500">ç›®å‰æ²’æœ‰è³‡æ–™</div>`;
        return;
      }

      container.innerHTML = filtered.map(app => {
        const status = app['ç‹€æ…‹'] || 'æœªçŸ¥';
        const id = app['ç”³è«‹ç·¨è™Ÿ'] || app['id'] || '';
        const created = app['æ™‚é–“æˆ³è¨˜'] ? new Date(app['æ™‚é–“æˆ³è¨˜']).toLocaleString() : '';

        return `<div class="border border-gray-200 rounded-xl p-4">
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold">${app['æ•™å…·å“åè¦æ ¼'] || '(æœªå¡«)'}</div>
            <div class="text-sm px-3 py-1 rounded-full bg-gray-100">${status}</div>
          </div>
          <div class="mt-2 text-sm text-gray-600">
            <div>ç”³è«‹äººï¼š${app['ç”³è«‹äºº'] || ''}</div>
            <div>ç”³è«‹ç·¨è™Ÿï¼š${id}</div>
            <div>é€å‡ºæ™‚é–“ï¼š${created}</div>
          </div>
        </div>`;
      }).join('');
    }

    // ====== æœå°‹ ======
    searchBtn.addEventListener('click', () => displayApplications(searchInput.value));
    searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchBtn.click(); });

    // ====== ç®¡ç†è€…ç™»å…¥ï¼ˆPOSTï¼šverify_passwordï¼‰ ======
    adminLoginBtn.addEventListener('click', () => adminModal.classList.remove('hidden'));
    cancelAdminLogin.addEventListener('click', () => adminModal.classList.add('hidden'));
    confirmAdminLogin.addEventListener('click', async () => {
      try {
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'verify_password', password: adminPasswordInput.value })
        });
        const result = await res.json();
        if (result.result === 'success') {
          isAdmin = true;
          adminModal.classList.add('hidden');
          showMessage(successMessage, 'ç®¡ç†è€…ç™»å…¥æˆåŠŸ');
        } else {
          showMessage(errorMessage, result.message || 'å¯†ç¢¼éŒ¯èª¤');
        }
      } catch (e) {
        console.error(e);
        showMessage(errorMessage, 'ç™»å…¥å¤±æ•—');
      }
    });

    // é è¨­åœåœ¨ç”³è«‹é 
    showView('apply');
  </script>
</body>
</html>
